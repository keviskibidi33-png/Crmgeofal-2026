services:
  # ========================================
  # GEOFAL CRM - Main Application (Directus)
  # ========================================
  geofal-crm:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: geofal-crm
    restart: unless-stopped
    environment:
      KEY: ${DIRECTUS_KEY}
      SECRET: ${DIRECTUS_SECRET}
      DB_CLIENT: pg
      DB_HOST: postgres
      DB_PORT: 5432
      DB_DATABASE: ${DB_DATABASE}
      DB_USER: ${DB_USER}
      DB_PASSWORD: ${DB_PASSWORD}
      ADMIN_EMAIL: ${ADMIN_EMAIL}
      ADMIN_PASSWORD: ${ADMIN_PASSWORD}
      PUBLIC_URL: ${PUBLIC_URL:-https://crm.geofal.com.pe}
      # Force database installation
      DIRECTUS_INSTALL_AUTO: "true"
      COTIZADOR_EXTERNAL_URL: https://cotizador.geofal.com.pe
      EXTENSIONS_PATH: /directus/extensions
      CONTENT_SECURITY_POLICY_DIRECTIVES__FRAME_SRC: "https://cotizador.geofal.com.pe"
      CONTENT_SECURITY_POLICY_DIRECTIVES__CONNECT_SRC: "'self' https://api.geofal.com.pe"
    volumes:
      - geofal_uploads:/directus/uploads
    depends_on:
      - postgres
      - cotizador-api
    networks:
      - geofal-network
    ports:
      - "8055:8055"
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.geofal-crm.rule=Host(`crm.geofal.com.pe`)"
      - "traefik.http.routers.geofal-crm.tls.certresolver=letsencrypt"
      - "traefik.http.services.geofal-crm.loadbalancer.server.port=8055"

  # ========================================
  # PostgreSQL Database
  # ========================================
  postgres:
    image: postgres:15-alpine
    container_name: geofal-postgres
    restart: unless-stopped
    environment:
      POSTGRES_DB: ${DB_DATABASE}
      POSTGRES_USER: ${DB_USER}
      POSTGRES_PASSWORD: ${DB_PASSWORD}
    volumes:
      - geofal_postgres_data:/var/lib/postgresql/data
    networks:
      - geofal-network

  # ========================================
  # COTIZADOR - Backend API (Python/FastAPI)
  # ========================================
  cotizador-api:
    build:
      context: ./cotizacion-twenty/quotes-service
      dockerfile: Dockerfile
    container_name: geofal-cotizador-api
    restart: unless-stopped
    environment:
      DB_HOST: postgres
      DB_PORT: 5432
      DB_DATABASE: ${DB_DATABASE}
      DB_USER: ${DB_USER}
      DB_PASSWORD: ${DB_PASSWORD}
      QUOTES_DATABASE_URL: postgresql://${DB_USER}:${DB_PASSWORD}@postgres:5432/${DB_DATABASE}
      QUOTES_CORS_ORIGINS: "*"
      DIRECTUS_URL: http://geofal-crm:8055
    volumes:
      - geofal_uploads:/app/uploads
      - ./cotizacion-twenty/Formato-cotizacion.xlsx:/app/Formato-cotizacion.xlsx
    depends_on:
      - postgres
    networks:
      - geofal-network
    ports:
      - "8001:8000"
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.geofal-api.rule=Host(`api.geofal.com.pe`)"
      - "traefik.http.routers.geofal-api.tls.certresolver=letsencrypt"
      - "traefik.http.services.geofal-api.loadbalancer.server.port=8000"

  # ========================================
  # COTIZADOR - Frontend (React/Vite)
  # ========================================
  cotizador-web:
    build:
      context: ./cotizacion-twenty/cotizador-web
      dockerfile: Dockerfile
      args:
        VITE_QUOTES_API_URL: https://api.geofal.com.pe
    container_name: geofal-cotizador-web
    restart: unless-stopped
    depends_on:
      - cotizador-api
    networks:
      - geofal-network
    ports:
      - "8081:80"
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.geofal-cotizador.rule=Host(`cotizador.geofal.com.pe`)"
      - "traefik.http.routers.geofal-cotizador.tls.certresolver=letsencrypt"
      - "traefik.http.services.geofal-cotizador.loadbalancer.server.port=80"

volumes:
  geofal_postgres_data:
  geofal_uploads:

networks:
  geofal-network:
    driver: bridge

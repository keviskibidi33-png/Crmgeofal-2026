import{useApi as t,useStores as e}from"@directus/extensions-sdk";import{computed as n,ref as r,onMounted as o,resolveComponent as a,openBlock as l,createBlock as i,withCtx as d,createVNode as c,createTextVNode as u,createCommentVNode as s,createElementVNode as p,createElementBlock as m,Fragment as b,renderList as f,toDisplayString as v,withDirectives as g,vModelText as h}from"vue";var x=[],y=[];!function(t,e){if(t&&"undefined"!=typeof document){var n,r=!0===e.prepend?"prepend":"append",o=!0===e.singleTag,a="string"==typeof e.container?document.querySelector(e.container):document.getElementsByTagName("head")[0];if(o){var l=x.indexOf(a);-1===l&&(l=x.push(a)-1,y[l]={}),n=y[l]&&y[l][r]?y[l][r]:y[l][r]=i()}else n=i();65279===t.charCodeAt(0)&&(t=t.substring(1)),n.styleSheet?n.styleSheet.cssText+=t:n.appendChild(document.createTextNode(t))}function i(){var t=document.createElement("style");if(t.setAttribute("type","text/css"),e.attributes)for(var n=Object.keys(e.attributes),o=0;o<n.length;o++)t.setAttribute(n[o],e.attributes[n[o]]);var l="prepend"===r?"afterbegin":"beforeend";return a.insertAdjacentElement(l,t),t}}("\n.iframe-container {\r\n\twidth: 100%;\r\n\theight: 100%;\r\n\tpadding: 0;\r\n\toverflow: hidden;\n}\n.cotizador-frame {\r\n\twidth: 100%;\r\n\theight: calc(100vh - 100px);\r\n\tborder: none;\n}\n.quotes-list {\r\n\tpadding: 8px;\n}\n.quote-item {\r\n\tpadding: 10px;\r\n\tmargin-bottom: 8px;\r\n\tbackground: var(--background-normal);\r\n\tborder-radius: 6px;\r\n\tcursor: pointer;\r\n\ttransition: background 0.2s;\n}\n.quote-item:hover {\r\n\tbackground: var(--background-normal-alt);\n}\n.quote-number {\r\n\tfont-weight: 600;\r\n\tcolor: var(--primary);\n}\n.quote-client {\r\n\tfont-size: 12px;\r\n\tcolor: var(--foreground-subdued);\r\n\tmargin-top: 2px;\n}\n.quote-total {\r\n\tfont-size: 13px;\r\n\tfont-weight: 500;\r\n\tmargin-top: 4px;\n}\n.loading, .empty {\r\n\ttext-align: center;\r\n\tpadding: 20px;\r\n\tcolor: var(--foreground-subdued);\n}\n.refresh-btn {\r\n\twidth: 100%;\r\n\tpadding: 8px;\r\n\tmargin-top: 10px;\r\n\tbackground: var(--background-normal);\r\n\tborder: 1px solid var(--border-normal);\r\n\tborder-radius: 4px;\r\n\tcursor: pointer;\r\n\tcolor: var(--foreground-normal);\n}\n.refresh-btn:hover {\r\n\tbackground: var(--background-normal-alt);\n}\n.main-content {\r\n\theight: 100%;\r\n\toverflow: auto;\n}\n.history-view {\r\n\tpadding: 20px;\n}\n.history-header {\r\n\tdisplay: flex;\r\n\tjustify-content: space-between;\r\n\talign-items: center;\r\n\tmargin-bottom: 20px;\n}\n.history-header h2 {\r\n\tmargin: 0;\r\n\tcolor: var(--foreground-normal);\n}\n.refresh-btn-main {\r\n\tpadding: 8px 16px;\r\n\tbackground: var(--primary);\r\n\tcolor: white;\r\n\tborder: none;\r\n\tborder-radius: 4px;\r\n\tcursor: pointer;\n}\n.quotes-table {\r\n\twidth: 100%;\r\n\tborder-collapse: collapse;\n}\n.quotes-table th,\r\n.quotes-table td {\r\n\tpadding: 12px;\r\n\ttext-align: left;\r\n\tborder-bottom: 1px solid var(--border-normal);\n}\n.quotes-table th {\r\n\tbackground: var(--background-normal);\r\n\tfont-weight: 600;\r\n\tcolor: var(--foreground-subdued);\n}\n.quotes-table tr:hover {\r\n\tbackground: var(--background-normal);\n}\n.quote-num {\r\n\tfont-weight: 600;\r\n\tcolor: var(--primary);\n}\n.action-btn {\r\n\tpadding: 4px 12px;\r\n\tbackground: var(--background-normal);\r\n\tborder: 1px solid var(--border-normal);\r\n\tborder-radius: 4px;\r\n\tcursor: pointer;\r\n\tcolor: var(--foreground-normal);\n}\n.action-btn:hover {\r\n\tbackground: var(--primary);\r\n\tcolor: white;\n}\n.action-btn.download {\r\n\tmargin-left: 4px;\n}\n.filters-section {\r\n\tbackground: var(--background-normal);\r\n\tpadding: 16px;\r\n\tborder-radius: 8px;\r\n\tmargin-bottom: 16px;\n}\n.filter-row {\r\n\tdisplay: flex;\r\n\tflex-wrap: wrap;\r\n\tgap: 16px;\r\n\talign-items: flex-end;\n}\n.filter-group {\r\n\tdisplay: flex;\r\n\tflex-direction: column;\r\n\tgap: 4px;\n}\n.filter-group label {\r\n\tfont-size: 12px;\r\n\tcolor: var(--foreground-subdued);\r\n\tfont-weight: 500;\n}\n.filter-input {\r\n\tpadding: 8px 12px;\r\n\tborder: 1px solid var(--border-normal);\r\n\tborder-radius: 4px;\r\n\tbackground: var(--background-page);\r\n\tcolor: var(--foreground-normal);\r\n\tmin-width: 150px;\n}\n.filter-input:focus {\r\n\toutline: none;\r\n\tborder-color: var(--primary);\n}\n.filter-actions {\r\n\tdisplay: flex;\r\n\tgap: 8px;\n}\n.btn-primary {\r\n\tpadding: 8px 16px;\r\n\tbackground: var(--primary);\r\n\tcolor: white;\r\n\tborder: none;\r\n\tborder-radius: 4px;\r\n\tcursor: pointer;\r\n\tfont-weight: 500;\n}\n.btn-primary:hover {\r\n\topacity: 0.9;\n}\n.btn-secondary {\r\n\tpadding: 8px 16px;\r\n\tbackground: var(--background-normal-alt);\r\n\tcolor: var(--foreground-normal);\r\n\tborder: 1px solid var(--border-normal);\r\n\tborder-radius: 4px;\r\n\tcursor: pointer;\n}\n.btn-secondary:hover {\r\n\tbackground: var(--background-normal);\n}\n.btn-download {\r\n\tpadding: 8px 16px;\r\n\tbackground: #10b981;\r\n\tcolor: white;\r\n\tborder: none;\r\n\tborder-radius: 4px;\r\n\tcursor: pointer;\r\n\tfont-weight: 500;\n}\n.btn-download:hover {\r\n\tbackground: #059669;\n}\n.results-info {\r\n\tpadding: 8px 12px;\r\n\tbackground: var(--background-normal);\r\n\tborder-radius: 4px;\r\n\tmargin-bottom: 12px;\r\n\tfont-size: 13px;\r\n\tcolor: var(--foreground-subdued);\n}\r\n",{});var w=(t,e)=>{const n=t.__vccOpts||t;for(const[t,r]of e)n[t]=r;return n};const k={setup(){const a=t(),{useUserStore:l}=e(),i=l(),d=n(()=>i.currentUser),c=r([]),u=r([]),s=r(!1),p=r("new"),m=r(""),b=r(""),f=r(""),v=n(()=>{const t=d.value;return t&&(t.role?.admin_access||t.admin_access)||!1}),g=n(()=>u.value.reduce((t,e)=>t+Number(e.total||0),0)),h="localhost"===window.location.hostname?"http://localhost:5173":"https://cotizador.geofal.com.pe",x=n(()=>{if(!d.value)return null;const t=new URLSearchParams({user_id:d.value.id,email:d.value.email||"",name:`${d.value.first_name||""} ${d.value.last_name||""}`.trim(),phone:d.value.phone||d.value.telefono||""});return`${h}?${t.toString()}`});async function y(){s.value=!0;try{const t=await a.get("/items/cotizaciones",{params:{limit:100,sort:["-created_at"],fields:["id","numero","year","cliente_nombre","proyecto","total","created_at","archivo_path"]}});c.value=t.data.data||[],u.value=c.value}catch(t){console.error("Error loading quotes:",t),c.value=[],u.value=[]}finally{s.value=!1}}function w(t){return Number(t||0).toFixed(2)}function k(t){if(!t)return"-";return new Date(t).toLocaleDateString("es-PE",{day:"2-digit",month:"2-digit",year:"numeric"})}return o(()=>{y()}),{userURL:x,quotes:c,filteredQuotes:u,loading:s,currentView:p,isAdmin:v,totalSum:g,searchText:m,dateFrom:b,dateTo:f,loadQuotes:y,loadQuotesFiltered:function(){let t=[...c.value];if(m.value){const e=m.value.toLowerCase();t=t.filter(t=>(t.cliente_nombre||"").toLowerCase().includes(e)||(t.proyecto||"").toLowerCase().includes(e)||(t.numero||"").toLowerCase().includes(e))}if(b.value){const e=new Date(b.value);t=t.filter(t=>new Date(t.created_at)>=e)}if(f.value){const e=new Date(f.value);e.setHours(23,59,59),t=t.filter(t=>new Date(t.created_at)<=e)}u.value=t},clearFilters:function(){m.value="",b.value="",f.value="",u.value=c.value},downloadReport:function(){const t=u.value.map(t=>[`${t.numero}-${String(t.year).slice(-2)}`,t.cliente_nombre||"",t.proyecto||"",w(t.total),k(t.created_at)]);let e=["NÂ° CotizaciÃ³n","Cliente","Proyecto","Total","Fecha"].join(",")+"\n";t.forEach(t=>{e+=t.map(t=>`"${t}"`).join(",")+"\n"}),e+=`\n"Total","","","${w(g.value)}",""`;const n=new Blob([e],{type:"text/csv;charset=utf-8;"}),r=URL.createObjectURL(n),o=document.createElement("a");o.href=r;const a=(new Date).toISOString().slice(0,10);o.download=`cotizaciones_${a}.csv`,o.click(),URL.revokeObjectURL(r)},downloadQuote:function(t){if(t.archivo_path){const e="localhost"===window.location.hostname?"http://localhost:8000":"https://api.geofal.com.pe";window.open(`${e}/download/${t.year}/${t.numero}`,"_blank")}else alert("No hay archivo disponible para esta cotizaciÃ³n")},formatNumber:w,formatDate:k,openQuote:function(t){window.open(`/admin/content/cotizaciones/${t.id}`,"_blank")},openDirectusCollection:function(){window.location.href="/admin/content/cotizaciones"}}}},_={class:"quotes-list"},C={key:0,class:"loading"},z={key:1,class:"empty"},q={key:2},Q=["onClick"],F={class:"quote-number"},S={class:"quote-client"},N={class:"quote-total"},L={class:"main-content"},T={key:0,class:"iframe-container"},D=["src"],R={class:"history-view"},U={class:"filters-section"},$={class:"filter-row"},V={class:"filter-group"},A={class:"filter-group"},j={class:"filter-group"},E={class:"filter-actions"},O={key:0,class:"results-info"},H={key:0},B={key:1,class:"loading"},P={key:2,class:"empty"},I={key:3,class:"quotes-table"},M={class:"quote-num"},G={class:"quote-total"},J=["onClick"],K=["onClick"];var W={id:"cotizador",name:"Cotizador",icon:"calculator",routes:[{path:"",component:w(k,[["render",function(t,e,n,r,o,x){const y=a("v-icon"),w=a("v-list-item-icon"),k=a("v-list-item-content"),W=a("v-list-item"),X=a("v-list"),Y=a("sidebar-detail"),Z=a("private-view");return l(),i(Z,{title:"Cotizador de Ventas"},{navigation:d(()=>[c(X,{nav:""},{default:d(()=>[c(W,{active:"new"===r.currentView,onClick:e[0]||(e[0]=t=>r.currentView="new"),clickable:""},{default:d(()=>[c(w,null,{default:d(()=>[c(y,{name:"add_circle"})]),_:1}),c(k,null,{default:d(()=>[...e[12]||(e[12]=[u("Nueva CotizaciÃ³n",-1)])]),_:1})]),_:1},8,["active"]),c(W,{active:"list"===r.currentView,onClick:e[1]||(e[1]=t=>{r.currentView="list",r.loadQuotesFiltered()}),clickable:""},{default:d(()=>[c(w,null,{default:d(()=>[c(y,{name:"list_alt"})]),_:1}),c(k,null,{default:d(()=>[...e[13]||(e[13]=[u("Historial",-1)])]),_:1})]),_:1},8,["active"]),r.isAdmin?(l(),i(W,{key:0,clickable:"",onClick:r.openDirectusCollection},{default:d(()=>[c(w,null,{default:d(()=>[c(y,{name:"table_chart"})]),_:1}),c(k,null,{default:d(()=>[...e[14]||(e[14]=[u("Administrar",-1)])]),_:1})]),_:1},8,["onClick"])):s("v-if",!0)]),_:1})]),sidebar:d(()=>[c(Y,{icon:"receipt_long",title:"Cotizaciones Recientes"},{default:d(()=>[p("div",_,[r.loading?(l(),m("div",C,"Cargando...")):0===r.quotes.length?(l(),m("div",z,"No hay cotizaciones")):(l(),m("div",q,[(l(!0),m(b,null,f(r.quotes,t=>(l(),m("div",{key:t.id,class:"quote-item",onClick:e=>r.openQuote(t)},[p("div",F,v(t.numero)+"-"+v(String(t.year).slice(-2)),1),p("div",S,v(t.cliente_nombre||"Sin cliente"),1),p("div",N,"S/ "+v(r.formatNumber(t.total)),1)],8,Q))),128))])),p("button",{class:"refresh-btn",onClick:e[2]||(e[2]=(...t)=>r.loadQuotes&&r.loadQuotes(...t))}," â†» Actualizar ")])]),_:1})]),default:d(()=>[p("div",L,[s(" Nueva CotizaciÃ³n (iframe) "),"new"===r.currentView?(l(),m("div",T,[r.userURL?(l(),m("iframe",{key:0,src:r.userURL,class:"cotizador-frame",frameborder:"0"},null,8,D)):s("v-if",!0)])):"list"===r.currentView?(l(),m(b,{key:1},[s(" Historial de cotizaciones "),p("div",R,[e[19]||(e[19]=p("div",{class:"history-header"},[p("h2",null,"Historial de Cotizaciones")],-1)),s(" Filtros "),p("div",U,[p("div",$,[p("div",V,[e[15]||(e[15]=p("label",null,"Buscar:",-1)),g(p("input",{type:"text","onUpdate:modelValue":e[3]||(e[3]=t=>r.searchText=t),placeholder:"Cliente, proyecto, nÃºmero...",class:"filter-input",onInput:e[4]||(e[4]=(...t)=>r.loadQuotesFiltered&&r.loadQuotesFiltered(...t))},null,544),[[h,r.searchText]])]),p("div",A,[e[16]||(e[16]=p("label",null,"Desde:",-1)),g(p("input",{type:"date","onUpdate:modelValue":e[5]||(e[5]=t=>r.dateFrom=t),class:"filter-input",onChange:e[6]||(e[6]=(...t)=>r.loadQuotesFiltered&&r.loadQuotesFiltered(...t))},null,544),[[h,r.dateFrom]])]),p("div",j,[e[17]||(e[17]=p("label",null,"Hasta:",-1)),g(p("input",{type:"date","onUpdate:modelValue":e[7]||(e[7]=t=>r.dateTo=t),class:"filter-input",onChange:e[8]||(e[8]=(...t)=>r.loadQuotesFiltered&&r.loadQuotesFiltered(...t))},null,544),[[h,r.dateTo]])]),p("div",E,[p("button",{class:"btn-primary",onClick:e[9]||(e[9]=(...t)=>r.loadQuotesFiltered&&r.loadQuotesFiltered(...t))},"ðŸ” Buscar"),p("button",{class:"btn-secondary",onClick:e[10]||(e[10]=(...t)=>r.clearFilters&&r.clearFilters(...t))},"âœ• Limpiar"),p("button",{class:"btn-download",onClick:e[11]||(e[11]=(...t)=>r.downloadReport&&r.downloadReport(...t))},"ðŸ“¥ Descargar")])])]),s(" Resultados "),r.filteredQuotes.length>0?(l(),m("div",O,[u(" Mostrando "+v(r.filteredQuotes.length)+" cotizaciones ",1),r.totalSum>0?(l(),m("span",H," | Total: S/ "+v(r.formatNumber(r.totalSum)),1)):s("v-if",!0)])):s("v-if",!0),r.loading?(l(),m("div",B,"Cargando...")):0===r.filteredQuotes.length?(l(),m("div",P,"No hay cotizaciones con estos filtros")):(l(),m("table",I,[e[18]||(e[18]=p("thead",null,[p("tr",null,[p("th",null,"NÂ° CotizaciÃ³n"),p("th",null,"Cliente"),p("th",null,"Proyecto"),p("th",null,"Total"),p("th",null,"Fecha"),p("th",null,"Acciones")])],-1)),p("tbody",null,[(l(!0),m(b,null,f(r.filteredQuotes,t=>(l(),m("tr",{key:t.id},[p("td",M,v(t.numero)+"-"+v(String(t.year).slice(-2)),1),p("td",null,v(t.cliente_nombre||"-"),1),p("td",null,v(t.proyecto||"-"),1),p("td",G,"S/ "+v(r.formatNumber(t.total)),1),p("td",null,v(r.formatDate(t.created_at)),1),p("td",null,[p("button",{class:"action-btn",onClick:e=>r.openQuote(t)},"Ver",8,J),p("button",{class:"action-btn download",onClick:e=>r.downloadQuote(t)},"ðŸ“¥",8,K)])]))),128))])]))])],2112)):s("v-if",!0)])]),_:1})}],["__file","module.vue"]])}]};export{W as default};
